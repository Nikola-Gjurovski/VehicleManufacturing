@model List<Domain.Order>
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
<a class="btn btn-success mb-3" asp-action="Index" asp-controller="VehicleFormulas">Go back</a>
<div class="container">
    <div class="row m-5">
        <table class="table" id="tblOrder" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Customer details</th>
                    <th>Vehicle name</th>
                    <th>Vehicle color</th>
                    <th>Company name</th>
                    <th>Vehicle type</th>
                    <th>Vehicle price</th>
                    <th>Is done</th>
                    <th>Details</th>
                    <th>Report</th>
                    <th>Vehicle status</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Count(); i++)
                {
                    var item = Model[i];
                    <tr>
                        <td>@(i + 1)</td>
                        <td>@item.ApplicationUser.UserName</td>
                        <td>@item.ShoppingCart.VehicleName</td>
                        <td>@item.ShoppingCart.VehicleColor</td>
                        <td>@item.ShoppingCart.CompanyName</td>
                        <td>@item.ShoppingCart.Type</td>
                        <td>@item.ShoppingCart.Price $</td>
                        <td>@(item.IsDone.HasValue && item.IsDone.Value ? "Yes" : "No")</td>
                        <td>
                            <a asp-action="OrdersAdminDetails" asp-route-id="@item.Id" class="btn btn-info">View Order</a>
                        </td>
                        <td>
                            <a asp-action="CreateInvoice" asp-route-id="@item.Id" class="btn btn-info">Create Invoice</a>
                          
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="sendEmail('@item.ApplicationUser.Email','@item.ShoppingCart.VehicleName', '@item.Id')">Set the vehicle status to done.</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" />
    <script>
        function sendEmail(email, name, orderId) {
            const subject = `Your Vehicle ${name} is Ready`;
            const body = `Your vehicle ${name} is done. We will send it to your location in a few days.`;

            // AJAX request to set IsDone to true
            $.ajax({
                url: '@Url.Action("SetIsDone", "Shopping")', // Replace with your controller action to set IsDone
                type: 'POST',
                data: { id: orderId },
                success: function (response) {
                    // On success, open email client with mailto link
                    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                },
                error: function (xhr, status, error) {
                    console.error(error);
                    alert('Error setting IsDone status.');
                }
            });
        }
    </script>
}
